#!/bin/sh
# Get archive URL in agr1, otherwise use main page. Generate filename.
URL=$1
if [ -n "$URL" ]; then
  MONTH=`echo $URL | sed -r 's,^.+([0-9]{4})/([0-9]{2}).+$,\1_\2,'`
  FILE="${MONTH}.html"
  [ -f $FILE ] && echo $FILE && exit 0
else
  URL="http://napirajz.hu/"
  FILE="index.html"
fi
echo "napi $URL $FILE" >&2

# Set up wget options depending on system, no -nc option on OpenWRT
uname -a | grep -i wrt || WGETOPT=-nc

# Try to retrieve webpage, or exit to avoid deleting data, get picture URLs
curl -f ${URL} >tmp || exit 1 
PICS=`cat tmp \
| sed -nr 's,^.+<img src=\"(/files/[/A-Za-z0-9_.]+)\".+$,http://napirajz.hu\1,p'`

# Print page header
cat > $FILE <<HEADER
<html><head><title>subogero napi $MONTH </title></head>
<body><hr><h1 align="center">subogero napi $MONTH </h1><hr>
HEADER

# Get pictures and print links to copies
for i in $PICS; do
  wget ${WGETOPT} "${i}"
  echo $i \
  | sed -r 's,^.+/([A-Za-z0-9_]+)(\.[jpeg]+)$,<a href=\"\1\2\">\1</a><br>,' \
  >> $FILE
done

# Print page footer
cat >> $FILE <<FOOTER
<hr> (c) CC - Mer&eacute;nyi D&aacute;niel
<br>Eredeti: h t t p : / / n a p i r a j z . h u
<p>Ez az oldal azok sz&aacute;m&aacute;ra k&eacute;sz&uuml;lt,
akiket a c&eacute;ges internet proxy megfosztott a napi rajz
ny&uacute;jtotta inspir&aacute;ci&oacute;t&oacute;l.
<hr>Friss&iacute;tve: `date "+%Y.%m.%d - %H:%M"`
</body></html>
FOOTER

# Return value
echo $FILE

